<?xml version="1.0"?>

<project name="ArchivesSpace" default="help">

  <property name="jruby_url" value="http://jruby.org.s3.amazonaws.com/downloads/1.7.0.RC2/jruby-complete-1.7.0.RC2.jar" />
  <property name="jruby_file" value="jruby-complete-1.7.0.RC2.jar" />

  <!-- We need a different version of JRuby for coverage reports until JRUBY-6106 gets merged -->
  <property name="coverage.jruby_url" value="http://aspace.hudmol.com/packages/jruby-trunk.jar" />
  <property name="coverage.jruby_file" value="jruby-coverage.jar" />

  <property name="gem_home" location="gems" />
  <property name="aspace.backend.port" value="4567" />
  <property name="aspace.frontend.port" value="3000" />
  <property environment="env"/>
  <property name="env.JAVA_OPTS" value="" />

  <target name="help" description="This help">
    <java classname="org.apache.tools.ant.Main">
      <arg value="-projecthelp" />
      <arg value="-buildfile" />
      <arg value="${ant.file}" />
    </java>
  </target>


  
  <!-- Configure our classpath.  Use our custom jar for JRuby if running code coverage tests. -->
  <target name="set-classpath" description="Set JRuby classpath">
    <condition property="jruby_classpath" value="${coverage.jruby_file}">
      <matches pattern=".*:coverage" string="${ant.project.invoked-targets}" />
    </condition>

    <condition property="jruby_classpath" value="${coverage.jruby_file}">
      <matches pattern="true" string="${env.COVERAGE_REPORTS}" />
    </condition>

    <condition property="COVERAGE_REPORTS" value="true">
      <matches pattern=".*:coverage" string="${ant.project.invoked-targets}" />
    </condition>

    <property name="jruby_classpath" value="${jruby_file}" />
    <property name="COVERAGE_REPORTS" value="false" />
  </target>


  <target name="bootstrap" description="Download JRuby and install all required gems">
    <delete>
      <fileset dir="." includes="jruby-complete*.jar" excludes="${jruby_file}" />
    </delete>
    <get src="${jruby_url}" dest="${jruby_file}" skipexisting="true" verbose="true" usetimestamp="true" />

    <java classpath="${jruby_file}" classname="org.jruby.Main" fork="true" failonerror="true">
      <jvmarg line="${env.JAVA_OPTS}"/>
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <arg line="--1.9 -S gem install bundler" />
    </java>

    <java classpath="${jruby_file}" classname="org.jruby.Main" fork="true" failonerror="true">
      <jvmarg line="${env.JAVA_OPTS}"/>
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <arg line="--1.9 gems/bin/bundle install --gemfile='../backend/Gemfile'" />
    </java>

    <java classpath="${jruby_file}" classname="org.jruby.Main" fork="true" failonerror="true">
      <jvmarg line="${env.JAVA_OPTS}"/>
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <arg line="--1.9 gems/bin/bundle install --gemfile='../frontend/Gemfile'" />
    </java>

    <java classpath="${jruby_file}" classname="org.jruby.Main" fork="true" failonerror="true">
      <jvmarg line="${env.JAVA_OPTS}"/>
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <arg line="--1.9 gems/bin/bundle install --gemfile='../selenium/Gemfile'" />
    </java>

    <java classpath="${jruby_file}" classname="org.jruby.Main" fork="true" failonerror="true">
      <jvmarg line="${env.JAVA_OPTS}"/>
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <arg line="--1.9 gems/bin/bundle install --gemfile='../_yard/Gemfile'" />
    </java>

    <java classpath="${jruby_file}" classname="org.jruby.Main" fork="true" failonerror="true">
      <jvmarg line="${env.JAVA_OPTS}"/>
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <arg line="--1.9 gems/bin/bundle install --gemfile='../migrations/Gemfile'" />
    </java>
  </target>


  <!-- Database -->
  <target name="db:migrate" depends="set-classpath" description="Run migrations against the database configured in config/config.rb">
    <java classpath="${jruby_classpath}" classname="org.jruby.Main" fork="true" failonerror="true"
          dir="..">
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <arg line="-Iapp/lib --1.9 build/scripts/migrate_db.rb" />
    </java>
  </target>


  <target name="db:nuke" depends="set-classpath" description="Run migrations against the database configured in config/config.rb">
    <java classpath="${jruby_classpath}" classname="org.jruby.Main" fork="true" failonerror="true"
          dir="..">
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <arg line="-Iapp/lib --1.9 build/scripts/migrate_db.rb nuke" />
    </java>
  </target>


  <!-- Common -->
  <target name="common:test" depends="set-classpath" description="Run the unit test suite for common">
    <java classpath="${jruby_classpath}" classname="org.jruby.Main" fork="true" 
          failonerror="true"
          dir="../common">
      <env key="GEM_HOME" value="${gem_home}" />
      <arg line="--1.9 ../build/gems/bin/rspec -P '*_spec.rb' --order rand:1 spec" />
    </java>
  </target>


  <!-- Backend -->
  <target name="backend:test" depends="set-classpath" description="Run the unit test suite">
    <java classpath="${jruby_classpath}" classname="org.jruby.Main" fork="true" 
          failonerror="true"
          dir="../backend">
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <env key="COVERAGE_REPORTS" value="${COVERAGE_REPORTS}" />
      <arg line="--1.9 -X-C ../build/gems/bin/rspec -b -P '*_spec.rb' --order rand:1 spec" />
    </java>
  </target>


  <target name="backend:integration" depends="set-classpath" description="Run the integration test suite">
    <java classpath="${jruby_classpath}" classname="org.jruby.Main" fork="true" 
          failonerror="true"
          dir="../backend">
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <arg line="--1.9 tests/integration.rb" />
    </java>
  </target>


  <target name="backend:war" depends="set-classpath, bootstrap" description="Deploy the backend application as a .war file">
    <java classpath="${jruby_classpath}" classname="org.jruby.Main" fork="true" failonerror="true"
          dir="../backend">
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <arg line="--1.9 ../build/gems/bin/warble war" />
    </java>
  </target>


  <target name="backend:devserver" depends="set-classpath" description="Start an instance of the ArchivesSpace backend development server">
    <java classpath="${jruby_classpath}" classname="org.jruby.Main" fork="true" failonerror="true"
          dir="../backend">
      <jvmarg line="${env.JAVA_OPTS}"/>
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <env key="ASPACE_INTEGRATION" value="${aspace.integration}" />
      <arg line="--1.9 app/main.rb ${aspace.backend.port}" />
    </java>
  </target>


  <target name="backend:doc" depends="set-classpath" description="Generate documentation for endpoints">
    <property name="match" value=""/>
    <java classpath="${jruby_classpath}" classname="org.jruby.Main" fork="true" failonerror="true" 
          dir="../backend">
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <arg line="--1.9 -Iapp scripts/endpoint_doc.rb"/>
      <arg value="${match}"/>
    </java>
  </target>


  <!-- Frontend -->
  <target name="frontend:clean" description="Delete the Rails tmp directory">
    <delete dir="../frontend/tmp" />
    <delete dir="../frontend/public/assets" />
    <mkdir dir="../frontend/public/assets" />
    <mkdir dir="../frontend/public/assets/00-do-not-put-things-here" />
  </target>
        

  <target name="frontend:devserver" depends="set-classpath, frontend:clean" description="Start an instance of the ArchivesSpace frontend development server">
    <java classpath="${jruby_classpath}" classname="org.jruby.Main" fork="true" failonerror="true"
          dir="../frontend">
      <jvmarg line="${env.JAVA_OPTS}"/>
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <arg line="--1.9 script/rails server --port=${aspace.frontend.port}" />
    </java>
  </target>


  <target name="frontend:console" depends="set-classpath" description="Run the rails console">
    <java classpath="${jruby_classpath}" classname="org.jruby.Main" fork="true" failonerror="true"
          dir="../frontend">
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <arg line="--1.9 script/rails console" />
    </java>
  </target>


  <target name="frontend:war" depends="set-classpath, frontend:clean, bootstrap" description="Deploy the frontend application as a .war file">
    <echo message="Precompiling Rails assets (this can take a little while...)" />

    <delete dir="../frontend/tmp" />

    <java classpath="${jruby_classpath}" classname="org.jruby.Main" fork="true"
          failonerror="true"
          dir="../frontend">
      <jvmarg line="${env.JAVA_OPTS}" />
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <arg line="--1.9 -S rake assets:precompile" />
    </java>

    <java classpath="${jruby_classpath}" classname="org.jruby.Main" fork="true"
          failonerror="true"
          dir="../frontend">
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <arg line="--1.9 ../build/gems/bin/warble war" />
    </java>
  </target>


  <!-- Migrations -->
  <target name="migrations:import:help" description="Show help for import in the migrations module">
    <java classpath="${jruby_file}" classname="org.jruby.Main" fork="true" 
          failonerror="true"
          dir="../migrations">
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <arg line="--1.9 ./import.rb --help" />
    </java>
  </target>

  <target name="migrations:import:list" description="List available importers in the migrations module">
    <java classpath="${jruby_file}" classname="org.jruby.Main" fork="true" 
          failonerror="true"
          dir="../migrations">
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <arg line="--1.9 ./import.rb --list-importers" />
    </java>
  </target>

  <target name="migrations:test" description="Run the migrations tests">
    <java classpath="${jruby_file}" classname="org.jruby.Main" fork="true" 
          failonerror="true"
          dir="../migrations/spec">
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <arg line="--1.9 ../../build/gems/bin/rspec -P '*_spec.rb' --order rand:1 ." />
    </java>
  </target>


  <!-- Selenium -->
  <target name="selenium:test" depends="set-classpath, frontend:clean" description="Run the Selenium tests">
    <java classpath="${jruby_classpath}" classname="org.jruby.Main" fork="true" 
          failonerror="true"
          dir="../selenium">
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <env key="COVERAGE_REPORTS" value="${COVERAGE_REPORTS}" />
      <arg line="--1.9 ../build/gems/bin/rspec -P '*_spec.rb' --order default -f d spec" />
    </java>
  </target>


  <target name="doc:yard" description="Generate the full YARD documentation">
    <java classpath="${jruby_file}" classname="org.jruby.Main" fork="true"
          failonerror="true"
          dir="../_yard">
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <arg line="--1.9 -S rake doc:gen" />
    </java>
  </target>


  <target name="doc:yardoc" description="Run the yardoc command">
    <java classpath="${jruby_file}" classname="org.jruby.Main" fork="true"
          failonerror="true"
          dir="..">
      <env key="GEM_HOME" value="${gem_home}" />
      <env key="GEM_PATH" value="" />
      <arg line="--1.9 build/gems/bin/yardoc" />
    </java>
  </target>


  <target name="dist" depends="backend:war, frontend:war" description="Build a standalone distribution jar of frontend, backend and all components">

    <mkdir dir="target" />

    <javac includeAntRuntime="false" fork="true" destdir="target" srcdir="../launcher/src" failonerror="true" classpath="../launcher/libs/*" />

    <jar jarfile="deps.jar">
      <zipgroupfileset dir="../launcher/libs" includes="*.jar" />
    </jar>

    <sleep seconds="1" />

    <jar jarfile="../archivesspace.jar" basedir="target">
      <zipfileset src="deps.jar" excludes="META-INF/*.SF" />

      <zipfileset src="../backend/backend.war" prefix="backend" />
      <zipfileset src="../frontend/frontend.war" prefix="frontend" />

      <manifest>
        <attribute name="Main-Class" value="org.archivesspace.Main" />
      </manifest>
    </jar>
  </target>


  <target name="bootstrap:coverage">
    <get src="${coverage.jruby_url}" dest="${coverage.jruby_file}" skipexisting="true" verbose="true" usetimestamp="true" />
  </target>

  <target name="backend:coverage" depends="set-classpath, bootstrap:coverage, backend:test" description="Generate coverage reports for the backend">
  </target>


  <target name="frontend:coverage" depends="set-classpath, bootstrap:coverage, frontend:clean, selenium:test"
          description="Generate coverage reports for the frontend">
  </target>


  <target name="test" depends="backend:test, backend:integration, common:test, selenium:test"
          description="Run the full suite of tests">
  </target>


</project>
